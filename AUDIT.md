# Глубокий аудит Ambient Life (NWN2)

Документ фиксирует выявленные противоречия, потенциальные ошибки логики и архитектуры, а также избыточные операции. Разбор опирается на текущий набор скриптов и описаний.

## 1) Ключевые противоречия и логические риски

### 1.1 Маршруты по слотам кешируются, но не используются большинством активностей

**Симптом:**

* `AL_CacheRoutesForAllSlots` сначала пытается кешировать `AL_WP_S0..AL_WP_S5` для каждого слота, а если их нет — кеширует маршруты по тегам активности.
* При обработке слота в `AL_NPC_OnUD` маршрут будет поставлен в очередь **только если** `AL_ActivityHasRequiredRoute` вернёт `TRUE`.
* `AL_ActivityHasRequiredRoute` возвращает `TRUE` **только** для активностей, явно требующих маршрута (`AL_WP_PACE`, `AL_WP_WWP`).

**Следствие:**

Маршруты `AL_WP_S0..AL_WP_S5` кешируются, но в большинстве случаев **не используются**, так как активность не «требует» маршрута. В результате:

* лишнее кеширование вхолостую;
* вводящая в заблуждение конфигурация (ожидание, что `AL_WP_Sx` будет применяться для обычных активностей).

**Рекомендация:**

Определиться с контрактом:

* либо считать, что маршрут по `AL_WP_Sx` используется для **любой** активности, где маршрут существует;
* либо убрать кеширование `AL_WP_Sx`, если оно не используется.

### 1.2 Активация области не выполняет синхронизацию реестра перед рассылкой RESYNC

**Симптом:**

При первом входе PC в область `AL_Area_OnEnter` вызывает `AL_UnhideAndResyncRegisteredNPCs`, но **не выполняет** синхронизацию реестра (`AL_SyncAreaNPCRegistry`).

**Риск:**

Если в период без игроков NPC были удалены/перемещены внешними скриптами, реестр мог устареть. В таком случае RESYNC может быть отправлен объектам вне области или «битым» ссылкам (до следующего тика синхронизации).

**Рекомендация:**

Включить быструю синхронизацию на момент активации области (после инкремента токена и до рассылки RESYNC), чтобы избежать рассылки по stale-реестру.

### 1.3 Жёсткий лимит 100 NPC на область может приводить к «тихой» деградации

**Симптом:**

`AL_MAX_NPCS = 100` ограничивает плотный массив `n0..n99`. При превышении лимита новые NPC просто не регистрируются.

**Риск:**

Система перестаёт управлять частью NPC, но не сигнализирует об этом. Это ведёт к непредсказуемому поведению в больших областях или при динамических спавнах.

**Рекомендация:**

* документировать лимит в инструкции установки;
* при необходимости — поднять лимит и/или логировать переполнение для диагностики.

## 2) Избыточные или потенциально дорогие операции

### 2.1 Полный обход объектов в `AL_CacheAreaRoutes`

**Симптом:**

При первом входе PC в область выполняется полный обход всех объектов (`GetFirstObjectInArea` / `GetNextObjectInArea`) с выборкой тегов.

**Наблюдение:**

Операция выполняется **единожды** на область и защищена флагом `al_routes_cached`, но для больших локаций это всё равно может быть заметным «пиком» при первом входе.

**Рекомендация:**

Если область очень большая — вручную ограничивать набор waypoint’ов либо инициировать кеширование заранее (например, при старте модуля), чтобы исключить пик при первом входе игрока.

### 2.2 Перекэш маршрутов для всех слотов на спавне

**Симптом:**

`AL_CacheRoutesForAllSlots` на каждом NPC пытается собрать маршруты для **всех** слотов. В крупных зонах со множеством NPC это может быть лишней работой.

**Рекомендация:**

Рассмотреть «ленивую» схему: кешировать маршрут **только** по текущему слоту (через `AL_RefreshRouteForSlot`), и обновлять при смене слота.

## 3) Прочие наблюдения

### 3.1 Механика «al_exit_counted»

Логика предотвращает двойное уменьшение счётчика игроков (OnExit + OnClientLeave). Это корректно, но требует помнить, что флаг чистится на OnEnter. При нестандартных телепортах или скриптовых перемещениях следует убедиться, что цепочка событий отрабатывает ожидаемо.

---

## Итог

Система в целом соответствует заявленной архитектуре «один тик на область», но выявленные пункты (особенно про маршруты `AL_WP_Sx` и синхронизацию реестра при активации) важны для стабильной работы и предсказуемости конфигурации. Документ предназначен как список улучшений/рисков для ближайшего планирования.
