# Глубокий аудит Ambient Life (NWN2)

Документ фиксирует выявленные противоречия, потенциальные ошибки логики и архитектуры, а также избыточные операции. Разбор опирается на текущий набор скриптов и описаний.

## 1) Ключевые противоречия и логические риски

### 1.1 Использование маршрутов зависит от наличия маршрута и совпадения тега

**Наблюдение:**

* Тег маршрута для слота берётся из `alwp<slot>`, а при отсутствии используется fallback `AL_WP_S<slot>` (функция `AL_GetDesiredRouteTag`).
* Маршрут кешируется по тегу в `AL_CacheRouteFromTag` и сохраняется как текущий тег слота.
* Проверка в `AL_ActivityHasRequiredRoute` возвращает `TRUE`, если у активности **нет** обязательного waypoint-тега, либо если сохранённый тег маршрута совпадает с требуемым тегом активности.

**Следствие:**

Маршрут **учитывается**, если он существует и (когда активность требует конкретного waypoint-тега) совпадает с ним. Для активностей без обязательного тега маршрут не блокирует выбор активности.

**Рекомендация:**

Уточнить в документации, что маршруты применяются при наличии маршрута и совпадении требуемого тега, а не только для узкого набора «маршрутных» активностей.

### 1.2 Активация области выполняет синхронизацию реестра перед рассылкой RESYNC

**Наблюдение:**

При первом входе PC в область `al_area_onenter` вызывает `AL_SyncAreaNPCRegistry`, а затем `AL_UnhideAndResyncRegisteredNPCs`. Таким образом, реестр актуализируется до рассылки RESYNC.

**Следствие:**

Риск рассылки RESYNC по устаревшему реестру в момент активации области уже устранён текущей последовательностью вызовов.

### 1.3 Жёсткий лимит 100 NPC на область может приводить к «тихой» деградации

**Симптом:**

`AL_MAX_NPCS = 100` ограничивает плотный массив `n0..n99`. При превышении лимита новые NPC просто не регистрируются.

**Риск:**

Система перестаёт управлять частью NPC, но не сигнализирует об этом. Это ведёт к непредсказуемому поведению в больших областях или при динамических спавнах.

**Рекомендация:**

* документировать лимит в инструкции установки;
* при необходимости — поднять лимит и/или логировать переполнение для диагностики.

## 2) Избыточные или потенциально дорогие операции

### 2.1 Полный обход объектов в `AL_CacheAreaRoutes`

**Симптом:**

При первом входе PC в область выполняется полный обход всех объектов (`GetFirstObjectInArea` / `GetNextObjectInArea`) с выборкой тегов.

**Наблюдение:**

Операция выполняется **единожды** на область и защищена флагом `al_routes_cached`, но для больших локаций это всё равно может быть заметным «пиком» при первом входе.

**Рекомендация:**

Если область очень большая — вручную ограничивать набор waypoint’ов либо инициировать кеширование заранее (например, при старте модуля), чтобы исключить пик при первом входе игрока.

### 2.2 Кеширование маршрутов по слотам и проверка тега активности

**Наблюдение:**

Маршрут для слота загружается по тегу (`alwp<slot>` или `AL_WP_S<slot>`), а использование маршрута дальше зависит от `AL_ActivityHasRequiredRoute`: активность проходит, если либо не требует waypoint-тега, либо тег маршрута совпадает.

**Рекомендация:**

Если нужно снизить стоимость кеширования, можно оценить целесообразность ленивого обновления слота, но учитывать, что корректность зависит от актуального совпадения тега маршрута с требованием активности.

## 3) Прочие наблюдения

### 3.1 Механика «al_exit_counted»

Логика предотвращает двойное уменьшение счётчика игроков (OnExit + OnClientLeave). Это корректно, но требует помнить, что флаг чистится на OnEnter. При нестандартных телепортах или скриптовых перемещениях следует убедиться, что цепочка событий отрабатывает ожидаемо.

---

## Итог

Система в целом соответствует заявленной архитектуре «один тик на область», но выявленные пункты (особенно про маршруты по слотам и синхронизацию реестра при активации) важны для стабильной работы и предсказуемости конфигурации. Документ предназначен как список улучшений/рисков для ближайшего планирования.
