# Установка Ambient Life (NWN2) — инструкция для чайников

Ниже — простые шаги, чтобы включить систему Ambient Life в ваш модуль. Если вы работаете впервые, следуйте по порядку.

---

## 0) Что вам понадобится

1. **Neverwinter Nights 2 Toolset** (NWN2 Toolset).
2. Доступ к вашему модулю (открыт в Toolset).
3. Скрипты Ambient Life из папки `scripts/`.

---

## 1) Импорт скриптов в модуль

1. Откройте ваш модуль в NWN2 Toolset.
2. Импортируйте все файлы из папки `scripts/`:
   - Обычно это делается через **File → Import** (или аналогичное меню).
3. Убедитесь, что скрипты появились в списке скриптов модуля.

**Важно:** импортируйте **все** `.nss` файлы, потому что они ссылаются друг на друга через `#include`.

---

## 2) Скомпилируйте скрипты

1. В Toolset выполните **Compile** для всех скриптов (обычно Build → Compile Module).
2. Убедитесь, что в логе компиляции нет ошибок.

> Если Toolset ругается на файлы `*_inc.nss` (ошибка про отсутствие `main`),
> пометьте их как **Include** (Script Type) или исключите из компиляции.
> Компилируются только «входные» скрипты, которые привязываются к событиям
> (см. п. 3).
>
> **Важно про имена:** NWN2 ограничивает resref скриптов 16 символами.
> Поэтому в этом репозитории уже используются короткие имена входных скриптов
> (например, `al_mod_onleave`, `al_npc_onud`). Если вы переименовываете файлы,
> следите, чтобы resref оставался ≤ 16 символов — иначе компилятор выдаст
> `Failed to open RESREF`.

---

## 3) Подключите скрипты к событиям

### 3.1 События области (Area)

Откройте нужную область и установите:

* **OnEnter** → `al_area_onenter`
* **OnExit** → `al_area_onexit`
* **OnHeartbeat** → оставить пустым

### 3.2 События модуля (Module)

В свойствах модуля:

* **OnClientLeave** → `al_mod_onleave`

### 3.3 События NPC

Для каждого NPC, которого должна контролировать система:

* **OnSpawn** → `al_npc_onspawn`
* **OnDeath** → `al_npc_ondeath`
* **OnUserDefined** → `al_npc_onud`

---

## 4) Назначение активностей NPC

Активность задаётся **только** локальным int `al_activity` на waypoint для
маршрутов. Другие механизмы (роли и слоты `a0..a5`) не используются. Если
маршрут отсутствует, применяется fallback-логика из
`AL_GetWaypointActivityForSlot` с локалами `al_slot_activity_<slot>` и
`al_default_activity` на NPC/области.

---

## 5) Настройка маршрутов (waypoints)

### 5.1 Общие маршруты по слотам

Если хотите, чтобы NPC ходил по маршруту в конкретный слот суток — создайте waypoints с тегами
и заранее сохраните эти теги на NPC:

* `alwp0`, `alwp1`, `alwp2`, `alwp3`, `alwp4`, `alwp5` → строка с тегом маршрута.

Маршрут по слоту используется **для любой активности** в этом слоте и имеет приоритет над
специальными маршрутами.

Если локальный `alwp<slot>` не задан, используется дефолтный тег
`AL_WP_S<slot>` для обратной совместимости.

### 5.2 Активность, определяемая waypoint

Активность определяется **самим waypoint’ом** (единый источник истины),
задайте на waypoint локальный int:

* `al_activity` → ID активности (см. `al_acts_inc.nss`)

Когда NPC находится на маршруте, значение `al_activity` для текущего waypoint’а
используется как активность.
Если `al_activity` не задан, NPC считается скрытым (активность 0).
Если маршрута нет, активность берётся через `AL_GetWaypointActivityForSlot`:
сначала `al_slot_activity_<slot>`, затем `al_default_activity` на NPC/области.

### 5.3 Активность, определяемая waypoint

Если нужно, чтобы активность определялась **самим waypoint’ом** (единый источник истины),
задайте на waypoint локальный int:

* `al_activity` → ID активности (см. `al_acts_inc.nss`)

Когда NPC находится на маршруте, значение `al_activity` для текущего waypoint’а
переопределяет слот `a0..a5`.
Если маршрута нет, активность берётся через `AL_GetWaypointActivityForSlot`:
сначала `al_slot_activity_<slot>`, затем `al_default_activity` на NPC/области.

---

## 6) Специальные пары NPC

### 6.1 Тренировочные партнёры

1. Назначьте двум NPC теги:
   * `FACTION_NPC1`
   * `FACTION_NPC2`
2. На уровне **области** добавьте локальные object-переменные:
   * `al_training_npc1_ref` → ссылка на `FACTION_NPC1`
   * `al_training_npc2_ref` → ссылка на `FACTION_NPC2`

### 6.2 Bartender + Barmaid

На уровне **области** задайте локальные object-переменные:

* `al_bar_bartender_ref` → ссылка на NPC с ролью Bartender
* `al_bar_barmaid_ref` → ссылка на NPC с ролью Barmaid

---

## 7) Межзонные переходы по маршруту (опционально)

Если маршрут должен переносить NPC в другую область (jump):

1. На нужном waypoint’е задайте **локальную локацию**:
   * `al_transition_location` (готовая location)

**Или** альтернативный вариант:

1. На waypoint’е задайте локальные переменные:
   * `al_transition_area` (object области)
   * `al_transition_x`, `al_transition_y`, `al_transition_z` (float)
   * `al_transition_facing` (float)

---

## 8) Ограничения, о которых важно помнить

* В реестре на область максимум **100 NPC**. Если NPC больше — лишние не управляются.
* Система не использует heartbeats на NPC — это нормально.
* Для работы маршрутов используйте **waypoints**, а не поиск объектов по тегам в рантайме.

---

## 9) Быстрая проверка (Smoke Test)

1. Запустите модуль.
2. Войдите персонажем в область:
   * NPC должны появиться (если были скрыты) и начать анимации.
3. Покиньте область:
   * NPC должны скрыться (pause).
4. Подождите смены времени суток:
   * NPC должны менять активность по waypoint’ам.

Если что-то не работает, проверьте:

* назначения событий (п. 3);
* наличие `al_activity` на waypoint’ах (п. 4);
* наличие waypoints (п. 5);
* компиляцию скриптов (п. 2).
